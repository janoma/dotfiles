#!/usr/bin/env bash

# Directory containing Resolve's databases
DATABASES_DIR="/Volumes/media01/Resolve/Databases"

# Directory to store the compressed database backups
BACKUPS_DIR="/Volumes/wolf02/Backups/Resolve_Databases"

# Remove backup files older than this number of days
KEEP_ALIVE=30

############################
# Do not modify after this #
############################

BOLD="\033[1m"
NORMAL="\033[0m"

if [ ! -d "${DATABASES_DIR}" ]; then
    echo -e "Directory ${BOLD}${DATABASES_DIR}${NORMAL} doesn't exist!"
    exit 1
fi

if [ ! -d "${BACKUPS_DIR}" ]; then
    echo -e "Directory ${BOLD}${BACKUPS_DIR}${NORMAL} doesn't exist!"
    exit 2
fi

if [ ! -w "${BACKUPS_DIR}" ]; then
    echo -e "Directory ${BOLD}${BACKUPS_DIR}${NORMAL} is not writable!"
    exit 3
fi

BACKUP_FILENAME="Database_$(date +"%Y%m%d%H%M%S").tar.bz2"

pushd "${DATABASES_DIR}/.." 1> /dev/null
tar -cjf "${BACKUPS_DIR}/${BACKUP_FILENAME}" Databases
popd

# Remove backup files older than $KEEP_ALIVE days
rm -f $(find "${BACKUPS_DIR}" -maxdepth 1 -name "Database_[0-9]*\.tar\.bz2" -Btime +${KEEP_ALIVE}d)

# vim: set syntax=sh formatoptions-=t :
